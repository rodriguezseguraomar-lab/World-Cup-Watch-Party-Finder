<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Location Map + Chat</title>

    <style>
        body {
            margin: 0;
            font-family: Arial,sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Login Screen */
        #loginScreen {
            width: 100%;
            min-height: 100vh;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: linear-gradient(135deg, #0b5ed7, #1e88e5);
            color: #fff;
        }

            #loginScreen h2 {
                font-size: 2rem;
                margin-bottom: 0.5rem;
            }

            #loginScreen p {
                font-size: 1rem;
                margin-bottom: 1.5rem;
            }

            #loginScreen input,
            #loginScreen button {
                width: 320px;
                max-width: 100%;
                padding: 12px 14px;
                margin-top: 10px;
                display: block;
                border-radius: 8px;
                font-size: 1rem;
            }

            #loginScreen button {
                background: #ffffff;
                color: #0b5ed7;
                border: none;
                font-weight: 600;
                cursor: pointer;
            }

                #loginScreen button:hover {
                    background: #e3f2fd;
                }

            #loginScreen h3 {
                margin-top: 1.5rem;
                margin-bottom: 0.5rem;
                color: #fff;
            }

        #appScreen {
            display: none;
            width: 100%;
            height: 100%;
        }

        #sidebar {
            width: 300px;
            background: #f7f7f7;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        #map {
            flex: 1;
        }

        #points {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        #chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }

        #chat-input {
            display: flex;
        }

            #chat-input input {
                flex: 1;
                padding: 10px;
                border: 1px solid #ccc;
            }

            #chat-input button {
                padding: 10px;
                border: none;
                background: #2196f3;
                color: white;
                cursor: pointer;
            }

        #add-location input,
        #add-location button {
            width: 90%;
            padding: 8px;
            margin: 5px auto;
            display: block;
        }
    </style>
</head>

<body>

    <div id="loginScreen">
        <h2>Group Login</h2>
        <button onclick="showJoin()">Yes, join group</button>
        <button onclick="showCreate()">No, create new group</button>

        <div id="joinGroup" style="display:none;">
            <input id="joinName" placeholder="Group Name">
            <input id="joinPass" type="password" placeholder="Password">
            <button onclick="joinGroup()">Enter Group</button>
        </div>

        <div id="createGroup" style="display:none;">
            <input id="newName" placeholder="New Group Name">
            <input id="newPass" type="password" placeholder="New Password">
            <button onclick="createGroup()">Create</button>
        </div>
    </div>

    <div id="appScreen">
        <div id="sidebar">
            <h3 id="groupTitle" style="margin:10px;"></h3>

            <div id="add-location">
                <input id="locName" placeholder="Location Name">
                <input id="locLat" placeholder="Latitude">
                <input id="locLng" placeholder="Longitude">
                <button onclick="addLocation()">Add Location</button>
            </div>

            <h3 style="margin:10px;">Group Points</h3>
            <div id="points"></div>

            <h3 style="margin:10px;">Group Chat</h3>
            <div id="chat">
                <div id="messages"></div>
                <div id="chat-input">
                    <input id="msgBox" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // ===== FIREBASE CONFIG =====
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional

        const firebaseConfig = {
            apiKey: "AIzaSyB5prj_6ldVN8CBtu3L8FN-rbKYleJK_Fg",
            authDomain: "groups-maps-site.firebaseapp.com",
            databaseURL: "https://groups-maps-site-default-rtdb.firebaseio.com",
            projectId: "groups-maps-site",
            storageBucket: "groups-maps-site.appspot.com",
            messagingSenderId: "366733392666",
            appId: "1:366733392666:web:8d88cbce35967587a74aa3"
        };

        firebase.initializeApp(firebaseConfig);
        const cloudDB = firebase.database();

        // ===== APP =====
        let currentGroup = null, map, markers = [], tempMarker = null;
        let db = {};

        // BUTTON FUNCTIONS
        function showJoin() {
            document.getElementById("joinGroup").style.display = "block";
            document.getElementById("createGroup").style.display = "none";
        }

        function showCreate() {
            document.getElementById("createGroup").style.display = "block";
            document.getElementById("joinGroup").style.display = "none";
        }

        // DATABASE FUNCTIONS
        function saveGroup() { return cloudDB.ref("groups/" + currentGroup).set(db[currentGroup]); }

        function loadGroup(name, cb) {
            cloudDB.ref("groups/" + name).once("value").then(s => {
                db[name] = s.val() || { password: "", locations: [], messages: [] };
                cb();
            });
        }

        function listenForLiveUpdates(name) {
            cloudDB.ref("groups/" + name).on("value", snap => {
                db[name] = snap.val();
                loadLocations();
                loadMessages();
                loadMarkers();
            });
        }

        // AUTH
        function createGroup() {
            let n = newName.value.trim(), p = newPass.value.trim();
            if (!n || !p) return alert("Fill fields");
            db[n] = { password: p, locations: [], messages: [] };
            currentGroup = n;
            saveGroup().then(() => login(n));
        }

        function joinGroup() {
            let n = joinName.value.trim(), p = joinPass.value.trim();
            loadGroup(n, () => {
                if (!db[n].password) return alert("Group not found");
                if (db[n].password !== p) return alert("Wrong password");
                login(n);
            });
        }

        function login(n) {
            currentGroup = n;
            loginScreen.style.display = "none";
            appScreen.style.display = "flex";
            groupTitle.textContent = "Group: " + n;
            loadGroup(n, () => {
                initMap();
                loadLocations();
                loadMessages();
                listenForLiveUpdates(n);
            });
        }

        // MAP
        async function initMap() {
            const { Map } = await google.maps.importLibrary("maps");
            map = new Map(document.getElementById("map"), { zoom: 3, center: { lat: 20, lng: 0 } });
            loadMarkers();
            map.addListener("click", e => placeTempMarker(e.latLng));
        }

        function placeTempMarker(latLng) {
            if (tempMarker) tempMarker.setMap(null);
            tempMarker = new google.maps.Marker({ position: latLng, map, draggable: true });
            locLat.value = latLng.lat();
            locLng.value = latLng.lng();
            tempMarker.addListener("dragend", () => {
                let p = tempMarker.getPosition();
                locLat.value = p.lat();
                locLng.value = p.lng();
            });
        }

        // DATA
        function addLocation() {
            let n = locName.value.trim(), lat = +locLat.value, lng = +locLng.value;
            if (!n || isNaN(lat) || isNaN(lng)) return alert("Invalid input");
            db[currentGroup].locations.push({ name: n, lat, lng });
            saveGroup();
            locName.value = locLat.value = locLng.value = "";
            if (tempMarker) { tempMarker.setMap(null); tempMarker = null; }
            loadLocations();
            loadMarkers();
        }

        // UI
        function loadLocations() {
            points.innerHTML = "";
            db[currentGroup]?.locations?.forEach(l => {
                let d = document.createElement("div");
                d.innerHTML = `<b>${l.name}</b><br>(${l.lat},${l.lng})<hr>`;
                points.appendChild(d);
            });
        }

        function loadMarkers() {
            markers.forEach(m => m.setMap(null));
            markers = [];
            db[currentGroup]?.locations?.forEach(l => {
                markers.push(new google.maps.Marker({
                    position: { lat: l.lat, lng: l.lng },
                    map: map,
                    title: l.name
                }));
            });
        }

        // CHAT
        function sendMessage() {
            let msg = msgBox.value.trim();
            if (!msg) return;
            db[currentGroup].messages.push(msg);
            saveGroup();
            msgBox.value = "";
            loadMessages();
        }

        function loadMessages() {
            messages.innerHTML = "";
            db[currentGroup]?.messages?.forEach(m => {
                let d = document.createElement("div");
                d.textContent = m;
                messages.appendChild(d);
            });
            messages.scrollTop = messages.scrollHeight;
        }
    </script>

    <!-- GOOGLE MAPS -->
    <script>
        (g => {
            let h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window;
            b = b[c] || (b[c] = {});
            const d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams;
            const u = () => h || (h = new Promise(async (f, n) => {
                await (a = m.createElement("script"));
                e.set("libraries", [...r] + "");
                for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]);
                e.set("callback", c + ".maps." + q);
                a.src = `https://maps.googleapis.com/maps/api/js?` + e;
                d[q] = f; a.onerror = () => n(Error(p + " could not load."));
                m.head.append(a);
            }));
            d[l] ? console.warn(p + " only loads once. Ignoring.") :
                d[l] = (f, ...n) => (r.add(f), u().then(() => d[l](f, ...n)));
        })({ key: "YOUR_GOOGLE_MAPS_KEY", v: "weekly" });
    </script>

</body>
</html>
