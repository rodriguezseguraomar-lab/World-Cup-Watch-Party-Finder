<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Group Location Map + Chat</title>
  <style>
    /* --- keep styling simple and readable --- */
    body{margin:0;font-family:Arial,sans-serif;display:flex;height:100vh;overflow:hidden}
    #loginScreen{width:100%;min-height:100vh;padding:40px 20px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;background:linear-gradient(135deg,#0b5ed7,#1e88e5);color:#fff}
    #loginScreen h2{font-size:2rem;margin-bottom:.5rem} #loginScreen p{font-size:1rem;margin-bottom:1.5rem}
    #loginScreen input,#loginScreen button{width:320px;max-width:100%;padding:12px 14px;margin-top:10px;display:block;border-radius:8px;font-size:1rem}
    #loginScreen button{background:#fff;color:#0b5ed7;border:none;font-weight:600;cursor:pointer}
    #loginScreen button:hover{background:#e3f2fd}
    #appScreen{display:none;width:100%;height:100%}
    #sidebar{width:320px;background:#f7f7f7;border-right:1px solid #ddd;display:flex;flex-direction:column;overflow-y:auto;padding-bottom:10px}
    #map{flex:1}
    #points{padding:10px;border-bottom:1px solid #ddd;overflow-y:auto}
    #chat{padding:10px;display:flex;flex-direction:column}
    #messages{flex:1;overflow-y:auto;padding:10px;background:#fff;border:1px solid #ccc;margin-bottom:10px;max-height:240px}
    #chat-input{display:flex}
    #chat-input input{flex:1;padding:10px;border:1px solid #ccc}
    #chat-input button{padding:10px;border:none;background:#2196f3;color:#fff;cursor:pointer}
    #add-location input,#add-location button{width:90%;padding:8px;margin:5px auto;display:block}
    .point-row{padding:6px;margin-bottom:6px;background:#fff;border-radius:6px;border:1px solid #e1e1e1}
    .msg-meta{font-size:0.8rem;color:#666;margin-bottom:4px}
  </style>
</head>
<body>

  <div id="loginScreen">
    <h2>Group Login</h2>
    <div>
      <button onclick="showJoin()">Yes, join group</button>
      <button onclick="showCreate()">No, create new group</button>
    </div>

    <div id="joinGroup" style="display:none;margin-top:12px">
      <input id="joinName" placeholder="Group Name">
      <input id="joinPass" type="password" placeholder="Password">
      <button onclick="joinGroup()">Enter Group</button>
    </div>

    <div id="createGroup" style="display:none;margin-top:12px">
      <input id="newName" placeholder="New Group Name">
      <input id="newPass" type="password" placeholder="New Password">
      <button onclick="createGroup()">Create</button>
    </div>
  </div>

  <div id="appScreen">
    <div id="sidebar">
      <h3 id="groupTitle" style="margin:10px 10px 0 10px"></h3>

      <div id="add-location" style="padding:0 10px 8px 10px">
        <input id="locName" placeholder="Location Name">
        <input id="locLat" placeholder="Latitude">
        <input id="locLng" placeholder="Longitude">
        <button onclick="addLocation()">Add Location</button>
        <small style="display:block;text-align:center;color:#777">Or click the map to place marker</small>
      </div>

      <h3 style="margin:10px">Group Points</h3>
      <div id="points"></div>

      <h3 style="margin:10px">Group Chat</h3>
      <div id="chat" style="padding:0 10px 10px 10px">
        <div id="messages"></div>
        <div id="chat-input">
          <input id="msgBox" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendMessage()">
          <button onclick="sendMessage()">Send</button>
        </div>
      </div>
    </div>

    <div id="map"></div>
  </div>

  <!-- Firebase (v8 sdk used in original file) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // ===== FIREBASE CONFIG =====
    const firebaseConfig = {
      apiKey: "AIzaSyB5prj_6ldVN8CBtu3L8FN-rbKYleJK_Fg",
      authDomain: "groups-maps-site.firebaseapp.com",
      databaseURL: "https://groups-maps-site-default-rtdb.firebaseio.com",
      projectId: "groups-maps-site",
      storageBucket: "groups-maps-site.appspot.com",
      messagingSenderId: "366733392666",
      appId: "1:366733392666:web:8d88cbce35967587a74aa3"
    };
    firebase.initializeApp(firebaseConfig);
    const cloudDB = firebase.database();

    // ===== APP STATE =====
    let currentGroup = null, map = null, markers = [], tempMarker = null;
    let db = {}; // local cache of group data

    // ----- UI helpers -----
    function $(id){ return document.getElementById(id); }

    // BUTTONS
    function showJoin(){ $('joinGroup').style.display='block'; $('createGroup').style.display='none'; }
    function showCreate(){ $('createGroup').style.display='block'; $('joinGroup').style.display='none'; }

    // DATABASE HELPERS
    function saveGroup(){ if(!currentGroup) return Promise.resolve(); return cloudDB.ref("groups/" + currentGroup).set(db[currentGroup]); }

    function loadGroup(name, cb){
      cloudDB.ref("groups/" + name).once("value").then(s => {
        db[name] = s.val() || { password: "", locations: [], messages: [] };
        if (typeof cb === 'function') cb();
      }).catch(err => {
        console.error('loadGroup error', err);
        alert('Failed to load group: ' + err.message);
      });
    }

    function listenForLiveUpdates(name){
      cloudDB.ref("groups/" + name).on("value", snap => {
        db[name] = snap.val() || { password: "", locations: [], messages: [] };
        loadLocations();
        loadMessages();
        loadMarkers();
      });
    }

    // AUTH
    function createGroup(){
      const n = $('newName').value.trim(), p = $('newPass').value.trim();
      if(!n || !p) return alert('Fill fields');
      db[n] = { password: p, locations: [], messages: [] };
      currentGroup = n;
      saveGroup().then(()=> login(n)).catch(e=>alert('Save failed: '+e.message));
    }

    function joinGroup(){
      const n = $('joinName').value.trim(), p = $('joinPass').value.trim();
      if(!n || !p) return alert('Fill fields');
      loadGroup(n, () => {
        if (!db[n].password) return alert('Group not found');
        if (db[n].password !== p) return alert('Wrong password');
        login(n);
      });
    }

    function login(n){
      currentGroup = n;
      $('loginScreen').style.display = 'none';
      $('appScreen').style.display = 'flex';
      $('groupTitle').textContent = 'Group: ' + n;
      // ensure we have local data, then init map and listeners
      loadGroup(n, () => {
        // we call initMap - if Maps library already loaded it will run immediately
        if (!map) {
          // if maps script hasn't loaded yet, it will call initMap via callback
          // so call it here; initMap is idempotent
          try { initMap(); } catch(e) { /* will be called by maps callback if not yet available */ }
        } else {
          loadLocations(); loadMessages(); loadMarkers();
        }
        listenForLiveUpdates(n);
      });
    }

    // MAP FUNCTIONS
    // Called by Google Maps API after it loads (see script tag below)
    function initMap(){
      // prevent double initialization
      if (map) return;
      // default center
      const defaultCenter = { lat: 20, lng: 0 };
      map = new google.maps.Map(document.getElementById('map'), { zoom: 3, center: defaultCenter });
      // if we already have a group loaded, draw markers
      loadMarkers();
      // allow clicking map to add a temp marker which fills lat/lng inputs
      map.addListener('click', e => enableMapClickForLocation(e.latLng));
    }

    // wrapper function named because your deployed code referenced it
    function enableMapClickForLocation(latLng){
      placeTempMarker(latLng);
    }

    function placeTempMarker(latLng){
      if (!map) return alert('Map not ready yet.');
      if (tempMarker) tempMarker.setMap(null);
      tempMarker = new google.maps.Marker({ position: latLng, map: map, draggable: true });
      $('locLat').value = latLng.lat();
      $('locLng').value = latLng.lng();
      tempMarker.addListener('dragend', () => {
        const p = tempMarker.getPosition();
        $('locLat').value = p.lat();
        $('locLng').value = p.lng();
      });
    }

    function loadMarkers(){
      if (!map) return; // wait for map
      // clear old markers
      markers.forEach(m => m.setMap(null));
      markers = [];
      const locations = db[currentGroup]?.locations || [];
      locations.forEach(l => {
        const m = new google.maps.Marker({
          position: { lat: +l.lat, lng: +l.lng },
          map: map,
          title: l.name
        });
        // simple click: open infowindow
        const iw = new google.maps.InfoWindow({ content: `<strong>${escapeHtml(l.name)}</strong><br>${l.lat}, ${l.lng}` });
        m.addListener('click', () => iw.open(map, m));
        markers.push(m);
      });
    }

    // DATA UI
    function addLocation(){
      const n = $('locName').value.trim(), lat = parseFloat($('locLat').value), lng = parseFloat($('locLng').value);
      if (!n || Number.isNaN(lat) || Number.isNaN(lng)) return alert('Invalid input');
      if (!db[currentGroup]) db[currentGroup] = { password: '', locations: [], messages: [] };
      db[currentGroup].locations.push({ name: n, lat: lat, lng: lng });
      saveGroup().then(()=> {
        $('locName').value = $('locLat').value = $('locLng').value = '';
        if (tempMarker) { tempMarker.setMap(null); tempMarker = null; }
        loadLocations();
        loadMarkers();
      }).catch(e=>alert('Save failed: '+e.message));
    }

    function loadLocations(){
      const points = $('points');
      points.innerHTML = '';
      (db[currentGroup]?.locations || []).forEach((l, idx) => {
        const d = document.createElement('div');
        d.className = 'point-row';
        d.innerHTML = `<b>${escapeHtml(l.name)}</b><div style="font-size:0.85rem;color:#555">(${l.lat}, ${l.lng})</div>`;
        // optional: button to center map on location
        const btn = document.createElement('button');
        btn.textContent = 'Center';
        btn.style.marginTop = '6px';
        btn.onclick = () => { map && map.setCenter({ lat: +l.lat, lng: +l.lng }); map && map.setZoom(10); };
        d.appendChild(btn);
        points.appendChild(d);
      });
    }

    // CHAT
    function sendMessage(){
      const raw = $('msgBox').value.trim();
      if(!raw) return;
      if (!db[currentGroup]) db[currentGroup] = { password: '', locations: [], messages: [] };
      // store messages as objects so we can later include user/time
      const msgObj = { text: raw, time: Date.now() };
      db[currentGroup].messages.push(msgObj);
      saveGroup().then(()=> {
        $('msgBox').value = '';
        loadMessages();
      }).catch(e=>alert('Failed to send message: ' + e.message));
    }

    function loadMessages(){
      const out = $('messages');
      out.innerHTML = '';
      const msgs = db[currentGroup]?.messages || [];
      msgs.forEach(m => {
        const d = document.createElement('div');
        const ts = m.time ? new Date(m.time).toLocaleString() : '';
        d.innerHTML = `<div class="msg-meta">${ts}</div><div>${escapeHtml(m.text || m)}</div>`;
        d.style.padding = '6px 4px';
        d.style.borderBottom = '1px solid #eee';
        out.appendChild(d);
      });
      out.scrollTop = out.scrollHeight;
    }

    // small utility
    function escapeHtml(s){
      if (s == null) return '';
      return String(s).replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]; });
    }

    // Helpful: allow safe reload in dev (clear listeners)
    window.onbeforeunload = () => {
      if (currentGroup) cloudDB.ref("groups/" + currentGroup).off();
    };
  </script>

  <!-- GOOGLE MAPS: replace key below with your actual key (you already set referrers in Cloud Console) -->
  <!-- Make sure the key is enabled for "Maps JavaScript API" in Cloud Console -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxnbNQkFoVwkBY4mMvqddPKg3LPAOHjyg&callback=initMap&libraries=places"></script>

</body>
</html>
